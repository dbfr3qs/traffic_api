
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>


<div id="container" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
<button id="addNew">Show PM</button>
<select id="selectMonth">
    <option value="1">Jan</option>
    <option value="2">Feb</option>
    <option value="3">March</option>
    <option value="4">April</option>
    <option selected="selected" value="5">May</option>
    <option value="6">June</option>
</select>

<script type="text/javascript">

function GetData(suburb, period, month) {
    var xhr = new XMLHttpRequest();
    var url = "http://localhost:3000/api/v1/etas";
    params = "suburb=" + suburb + "&period=" + period + "&month=" + month;
    xhr.open("POST", url, false);
    xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xhr.send(params);

    var result = JSON.parse(xhr.responseText);

    return result;
}

function updateGraph(period, month) {
    var _date = new Date();
    _date.setMonth(month - 1);
    monthName = _date.toLocaleString('en-nz', { month: "long" });
    var chart = $('#container').highcharts();

    chart.series[0].setData(GetData('Melling', period, month)[1], false);
    chart.series[0].update({ name: "Melling " + period }, false);
    chart.series[1].setData(GetData('Porirua', period, month)[1], false);
    chart.series[1].update({ name: "Porirua " + period }, false);
    chart.series[2].setData(GetData('Petone', period, month)[1], false);
    chart.series[2].update({ name: "Petone " + period }, false);
    chart.series[3].setData(GetData('Manor Park', period, month)[1], false);
    chart.series[3].update({ name: "Manor Park " + period }, false);
    chart.series[4].setData(GetData('JVille', period, month)[1], false);
    chart.series[4].update({ name: "JVille " + period }, false);
    chart.series[5].setData(GetData('Paekak', period, month)[1], false);
    chart.series[5].update({ name: "Paekak " + period }, false);
    
    chart.xAxis[0].update({ 
        title: {
            text: "Days in " + monthName
        },
    });

    chart.xAxis[0].categories = GetData('Porirua', period, month)[0];
}

$(function() {
    var month = new Date().getMonth();
    _date = new Date();
    _date.setMonth(month - 1);
    month = month.toString();
    var monthName = _date.toLocaleString('en-nz', { month: "long" });
    console.log(monthName);

    $('#container').highcharts({
        title: {
            text: 'Average rush hour ETA',
            x: -20 //center
        },
        subtitle: {
            text: 'Source: NZTA Wellington',
            x: -20
        },
        xAxis: {
            title: {
                text: 'Days in ' + monthName
            },
            categories: GetData('Melling', 'AM', month)[0]
        },
        yAxis: {
            title: {
                text: 'Time in minutes'
            },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {
            valueSuffix: ' Minutes'
        },
        legend: {
            layout: 'vertical',
            align: 'right',
            verticalAlign: 'middle',
            borderWidth: 0
        },
        series: [{
            name: 'Melling AM',
            data: GetData('Melling', 'AM', month)[1]
        }, {
            name: 'Porirua AM',
            data: GetData('Porirua', 'AM', month)[1]
        }, {
            name: 'Petone AM',
            data: GetData('Petone', 'AM', month)[1]
        }, {
            name: 'Manor Park AM',
            data: GetData('Manor Park', 'AM', month)[1]
        }, {
            name: 'JVille AM',
            data: GetData('JVille', 'AM', month)[1]
        }, {
            name: 'Paekak AM',
            data: GetData('Paekak', 'AM', month)[1]
        }]
            
    });
    
    $('#selectMonth').on('change', function(e) {
        month = $(this).val();
        console.log($(this).val());
        if ($('#addNew').text() == "Show PM") {
            period = 'PM';
            $('#addNew').html('Show AM'); 
        }
        else if ($('#addNew').text() == "Show AM") {
            period = 'AM';
            $('#addNew').html('Show PM'); 
        }
        console.log(period);
        updateGraph(period, month);
        $('#container').highcharts().redraw();

    });

    $('#addNew').on('click', function(e) {
        var period = "";
        console.log($(this).text());

        if ($(this).text() == "Show PM") {
            period = "PM";
            console.log($(this).text());
            console.log(period);

        } 
        else if ($(this).text() == "Show AM") {            
            period = "AM";
            console.log($(this).text());
            console.log(period);
        }

        updateGraph(period, month);
        
        if (period == "PM") { 
            $('#addNew').html('Show AM'); 
        }

        if (period == "AM") {
            $('#addNew').html('Show PM');
        }
        $('#container').highcharts().yAxis[0].isDirty = true;
        $('#container').highcharts().redraw();

    });
});
</script>